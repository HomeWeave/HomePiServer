<html>
<head>
    <title>Plugins</title>
</head>
<body>
    <script type="text/x-template" id="template-all-components">
        <!-- TODO: Remove one level of hierarchy of div -->
        <div v-if="data.type == 'vertical-layout'">
            <vertical-layout v-bind:data="data"></vertical-layout>
        </div>
        <div v-else-if="data.type == 'h3'">
            <header-3 v-bind:data="data.text"></header-3>
        </div>
        <div v-else-if="data.type == 'paragraph'">
            <paragraph v-bind:data="data.text"></paragraph>
        </div>
        <div v-else-if="data.type == 'button'">
            <weave-button v-bind:data="data"></weave-button>
        </div>
        <div v-else-if="data.type == 'textbox'">
            <weave-textbox v-bind:data="data"></weave-textbox>
        </div>
    </script>
    <script type="text/x-template" id="template-vertical-layout">
        <div>
            <div class="row" v-for="item in data.items">
                <div v-bind:class="'col-lg-' + data.columnsLarge + ' col-md-' + data.columnsMedium + ' col-sm-' + data.columnsSmall">
                    <all-components v-bind:data="item"></all-components>
                </div>
            </div>
        <div>
    </script>
    <script type="text/x-template" id="template-paragraph">
        <p>{{$root.processUITemplate(data)}}</p>
    </script>
    <script type="text/x-template" id="template-h3">
        <h3>{{data}}</h3>
    </script>
    <script type="text/x-template" id="template-button">
        <button v-on:click="$root.fireEvent(data.onclick)">
            {{data.text}}
        </button>
    </script>
    <script type="text/x-template" id="template-textbox">
        <input type="text" v-on:input="$root.updateVariable(data.variable, $event.target.value)">
    </script>
    <script id="template-plugin" type="text/x-template">
        <div>
            <div v-for="item in data">
                <p>{{item.name}}</p>
                <p>{{item.description}}</p>
                <button v-if="!item.progress && !item.enabled && item.installed"
                        v-on:click="activate(item)">Activate</button>
                <button v-if="!item.progress && item.enabled && item.installed">Deactivate</button>
                <button v-if="!item.progress && !item.installed" v-on:click="install(item)">Install</button>
                <button disabled v-if="item.progress">Action in Progress</button>
            </div>
        </div>
    </script>
    <div id="root">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js" integrity="sha256-TaLceMwjWRqe4yhbqPOJH6V7UGt5AvvdNfpaIXJWbFU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.core.min.js" integrity="sha256-Q+4FYyw42bZJQS9v3+BXNtPLNxKqDLKIEPt50Z4fiYw=" crossorigin="anonymous"></script>
    <script src="/static/js/weave.js"></script>
    <script>
        var app = {
            "$variables": {},
            "$actions": {
                "$load": [
                    {
                        "type": "$rpc",
                        "data": {
                            "package_name": "weaveserver.services.plugins",
                            "rpc_name": "plugins",
                            "api_name": "list_available",
                            "args": [],
                            "kwargs": {}
                        },
                        "success": [
                            {
                                "type": "$store",
                                "keys": ["variables", "plugins"],
                                "value": {
                                    "__vartype": "result",
                                    "__expression": {
                                        "keys": [0]
                                    }
                                }
                            }
                        ]
                    }
                ],
                "install": [
                    {
                        "type": "$rpc",
                        "data": {
                            "package_name": "weaveserver.services.plugins",
                            "rpc_name": "plugins",
                            "api_name": "install_plugin"
                        }
                    }
                ],
                "activate": [
                    {
                        "type": "$rpc",
                        "data": {
                            "package_name": "weaveserver.services.plugins",
                            "rpc_name": "plugins",
                            "api_name": "activate"
                        }
                    }
                ],
                "deactivate": [
                    {
                        "type": "$rpc",
                        "data": {
                            "package_name": "weaveserver.services.plugins",
                            "rpc_name": "plugins",
                            "api_name": "deactivate"
                        }
                    }
                ]
            },
            "$ui": {
                "type": "vertical-layout",
                "columnsLarge": 12,
                "columnsMedium": 12,
                "columnsSmall": 12,
                "items": [
                    {
                        "type": "loop",
                        "variable": ["plugins"],
                        "template": {
                            "type": "vertical-layout",
                            "columnsLarge": 12,
                            "columnsMedium": 12,
                            "columnsSmall": 12,
                            "items": [
                                {
                                    "type": "h3",
                                    "text": {
                                        "__vartype": "context",
                                        "__expression": {
                                            "keys": ["name"]
                                        }
                                    }
                                },
                                {
                                    "type": "paragraph",
                                    "text": {
                                        "__vartype": "context",
                                        "__expression": {
                                            "keys": ["description"]
                                        }
                                    }
                                },
                                {
                                    "type": "condition",
                                    "op": "eq",
                                    "operands": [
                                        [
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["installed"]
                                                }
                                            },
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["enabled"]
                                                }
                                            }
                                        ],
                                        [false, false]
                                    ],
                                    "value": {
                                        "type": "button",
                                        "text": "Install",
                                        "onclick": [
                                            {
                                                "type": "$action",
                                                "action": "install",
                                                "data": [
                                                    {
                                                        "keys": [0, "data", "args"],
                                                        "value": [
                                                            "git",
                                                            {
                                                                "__vartype": "context",
                                                                "__expression": {
                                                                    "keys": ["url"]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                {
                                    "type": "condition",
                                    "op": "eq",
                                    "operands": [
                                        [
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["installed"]
                                                }
                                            },
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["enabled"]
                                                }
                                            }
                                        ],
                                        [true, false]
                                    ],
                                    "value": {
                                        "type": "button",
                                        "text": "Activate",
                                        "onclick": [
                                            {
                                                "type": "$action",
                                                "action": "activate",
                                                "data": [
                                                    {
                                                        "keys": [0, "data", "args"],
                                                        "value": [
                                                            {
                                                                "__vartype": "context",
                                                                "__expression": {
                                                                    "keys": ["id"]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                {
                                    "type": "condition",
                                    "op": "eq",
                                    "operands": [
                                        [
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["installed"]
                                                }
                                            },
                                            {
                                                "__vartype": "context",
                                                "__expression": {
                                                    "keys": ["enabled"]
                                                }
                                            }
                                        ],
                                        [true, true]
                                    ],
                                    "value": {
                                        "type": "button",
                                        "text": "Deactivate",
                                        "onclick": [
                                            {
                                                "type": "$action",
                                                "action": "deactivate",
                                                "data": [
                                                    {
                                                        "keys": [0, "data", "args"],
                                                        "value": [
                                                            {
                                                                "__vartype": "context",
                                                                "__expression": {
                                                                    "keys": ["id"]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        };
        function install(plugin) {
            return rpc("weaveserver.services.plugins", "plugins", "install_plugin", ["git", plugin.url], {});
        }

        function activate(plugin) {
            return rpc("weaveserver.services.plugins", "plugins", "activate", [plugin.id], {});
        }

        $(document).ready(function() {
            registerComponent('vertical-layout', '#template-vertical-layout');
            registerComponent('header-3', '#template-h3');
            registerComponent('paragraph', '#template-paragraph');
            registerComponent('weave-button', '#template-button');
            registerComponent('weave-textbox', '#template-textbox');
            var application = GenericApplication("#root", app);
        });
    </script>
</body>
</html>